- @title = t('titles.searches.show')
- @with_map = true

= render 'search_form', search: @search.dup

- if @house_center
  .house
    .row
      .col-xs-12
        #{t('.text_at_house')} #{house_marker(@house_center)}:
        - has_a_location_here = false
        - @house_center.locations.each do |location|
          - if location.user == current_user
            - has_a_location_here = true
          - else
            = user_marker(location.user)
            (#{link_to articles_count(location.articles), location_path(location)})
        - if has_a_location_here
          = t('.and_you')
          %span.glyphicon.glyphicon-heart
          !

-#.row
  .col-xs-12
    -#test024{"data-spy": "affix", "data-offset-top":"195"}
      Irgendein bl√∂dsinn
    -#mapid{style: "width: -1; height: 400px;", "data-spy": "affix", "data-offset-top":"195"}
    #mapid{style: "width: 100%; height: 300px;"}
#results
  -#= render 'results'

:javascript
  onMapClick = function(e) {
    console.log("You clicked the marker " + e.target.index);
  };
  
  $(document).ready(function() {
    //$('#mapid').hide()
  
    #{render 'articles/map_index.js.erb', articles: @articles, formats: [:js]}
    
    var reloadSearch = function() {
      // create request
      console.log("redirect")
      //var center = window.map.getBounds().getCenter();
      var nw = window.map.getBounds().getNorthWest();
      var se = window.map.getBounds().getSouthEast();
      //var distance = window.map.getBounds().getNorthEast().distanceTo(center);
      url = "?" +
            //"search%5Bradius%5D=" + distance/1000 + "&" +
            //"search%5Blongitude%5D=" + center.lng + "&" +
            //"search%5Blatitude%5D=" + center.lat + "&" +
            //"search%5Bnw_lng%5D=" + nw.lng + "&" +
            //"search%5Bnw_lat%5D=" + nw.lat + "&" +
            //"search%5Bse_lng%5D=" + se.lng + "&" +
            //"search%5Bse_lat%5D=" + se.lat + "&" +
            "mapupdate=true" + "&" +
            "nw_lng=" + nw.lng + "&" +
            "nw_lat=" + nw.lat + "&" +
            "se_lng=" + se.lng + "&" +
            "se_lat=" + se.lat;
            //"search%5Buse_location%5D=0" + "&" +
            //"search%5Bpattern%5D=" + "#{@search.pattern}" + "&" +
            //"commit=Map";
            
      // window.location.search = url
      $.getScript(url)
      //$.getScript(url, function(resonse, status) {
      // console.log("got an answer")
      //})
    }
  
    if ( typeof window.map !== 'undefined' ) {
      window.map.on('zoomend', reloadSearch)
      window.map.on('moveend', reloadSearch)
    }

    reloadSearch();
    //$('#mapid').show()
  });

