- @title = t('titles.articles.new_from_stockitems')

.col-xs-12.col-sm-3.col-sm-push-9
  = tipp_panel do
    = render 'new_from_stockitems_help'

.col-xs-12.col-sm-9.col-sm-pull-3
  %h3= @title
  #article_null_div.article
    .row
      .col-xs-8
        = link_to t(".link_create_without_template"), "", id: "article_new_button"
      .col-xs-4.text-right
        #all_article_count
          - narticles = current_user.articles.count
          = t('.text_you_already_have')
          = content_tag :span, "#{narticles}"
          = "#{Article.model_name.human(count: narticles)}!"

    #article_new.row.article_edit
      .col-xs-12
        = render 'form', article: Article.new
        
  %div
    - @rooms.each do |room|
      %div
        %h4
          = room
        %div{:id => "#{underscore(room)}"}
          - @articles[room].each do |article|
            - article_div_id = "article_" + article.stockitem_id.to_s + "_div"
            .article{:id => article_div_id}
              .row
                .col-xs-6
                  %a.article_cb{"data-article-id" => "#{article.stockitem_id.to_s}", :href => "#"}
                    = article.title
                        
                .col-xs-6.text-right
                  - # wieviele artikel hat der nutzer schon mit diesem stockitem erstellt
                  - # anders gefragt: wieviele artikel des nutzers gibt es, deren stockitem die gleiche idee hat, wie die id dieses stockitems
                  - nstockitems = current_user.articles.where("stockitem_id = ?", article.stockitem_id).count
                  .article_count{:data => nstockitems}
                    = t('.text_you_already_have')
                    = content_tag :span, "#{nstockitems}"
                    = t('.text_of_this')
                  - if current_user.role == "admin"
                    - narticles = Article.where("stockitem_id = ?", article.stockitem_id).count
                    .admin-buttons
                      = link_to "", edit_stockitem_path(article.stockitem), class: "glyphicon glyphicon-pencil btn btn-danger btn-xs"
                      = link_to "", article.stockitem, method: :delete, data: {confirm: "delete " + article.stockitem.title + "? " + narticles.to_s + " References."} , class: "glyphicon glyphicon-remove btn btn-danger btn-xs"

              .row.article_edit
                .col-xs-12
                  = render 'form', article: article
                  
= render 'layouts/modal_error'

:javascript
  $(document).ready(function(){
    $(".article_edit").hide();
    
    $(".article_cb").click( function(e) {
      e.preventDefault();
      var thedivid = "#article_" + $(this).attr("data-article-id") + "_div .article_edit";
      console.log(thedivid);
      $(thedivid).toggle(200);
    });
    
    $('body').on('click', '.article_gratis_cb', function(e) {
      var thedivid = "#article_" + $(this).attr("data-article-id") + "_div .article_rate";
      console.log(thedivid);
      //$(this).parents("form").find(".article_rate").toggle(200);
      $(thedivid).toggle(200);
    });
    
    $(".article_count[data=0]").hide();

    $("#article_new").hide();

    $("body").on("click", "#article_new_button", function(e) {
      e.preventDefault();
      var thedivid = "#article_null_div .article_edit";
      console.log(thedivid);
      $(thedivid).toggle(200);
    });

    $('body').on("ajax:success", function(e, data, status, xhr) {
      console.log("Success");
    });

    $('body').on("ajax:error", function(e, xhr, status, error) {
      console.log("Error");
      $("#modal-error").modal("show");
    });

  });

  var onCreateSuccess = function(article_id, stockitem_id, newText, formText, nstockitems, narticles){
    console.log("within on create")
    // hide the edit div
    var edit_div_id = "#article_" + stockitem_id + "_div .article_edit"
    $(edit_div_id).hide(200);

    // reset the form 
    if ( stockitem_id == "null" ) {
      $("#article_new div form").trigger("reset");
        
      // unhide the rate field of the new form (just in case)
      var thedivid = "#article_null_div .article_rate";
      console.log(thedivid);
      $(thedivid).show(200);
      
      // replace the form content (so no need to reset the form, right?)
      $("#article_null_div" + "#new_article").replaceWith(formText)

    }
    else {
      // replace the form content (so no need to reset the form, right?)
      $("#article_" + stockitem_id + "_div #new_article").replaceWith(formText)

      // if it was the from the template free form
      // show the counter
      var count_div_id = "#article_" + stockitem_id + "_div .article_count";
      $(count_div_id).show(200);
      
      // edit counter value
      var count_span_id = count_div_id + " span"
      console.log(count_span_id)
      $(count_span_id).text(nstockitems);
    }
    
    // edit all article counter value
    $('#all_article_count span').text(narticles);
  };

  var onCreateError = function(article_id, stockitem_id, newText, formText, nstockitems){
    console.log("within onCreateError")

    // replace the form content (so no need to reset the form, right?)
    if ( stockitem_id == "null" ) {
      $("#article_null_div #new_article").replaceWith(formText)
    } else {
      $("#article_" + stockitem_id + "_div #new_article").replaceWith(formText)
    }
    
  };
